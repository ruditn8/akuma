name: SSH Ngrok 24/7 Enhanced

on:
  push:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
    - name: Download ngrok
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar xvzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
    
    - name: Auth ngrok
      run: ./ngrok authtoken ${{ secrets.NGROK_TOKEN }}
    
    - name: Setup SSH
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server jq
        sudo systemctl start ssh
        sudo systemctl enable ssh
    
    - name: Set User Password
      run: |
        echo "runner:P@ssw0rd!" | sudo chpasswd
    
    - name: Start ngrok and keep alive
      run: |
        ./ngrok tcp 22 > /dev/null &
        sleep 10
        
        NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        NGROK_HOST=$(echo $NGROK_URL | sed 's|tcp://||' | cut -d':' -f1)
        NGROK_PORT=$(echo $NGROK_URL | sed 's|tcp://||' | cut -d':' -f2)
        
        echo "=========================================="
        echo "ðŸš€ SSH Server Ready!"
        echo "=========================================="
        echo "Host: $NGROK_HOST"
        echo "Port: $NGROK_PORT"
        echo "User: runner"
        echo "Pass: P@ssw0rd!"
        echo ""
        echo "Command:"
        echo "ssh runner@$NGROK_HOST -p $NGROK_PORT"
        echo "=========================================="
        
        # Keep alive dengan health check
        END_TIME=$(($(date +%s) + 21000))
        CHECK_INTERVAL=300  # Check setiap 5 menit
        
        while [ $(date +%s) -lt $END_TIME ]; do
          REMAINING=$(( ($END_TIME - $(date +%s)) / 60 ))
          echo "[$(date '+%H:%M:%S')] âœ… Tunnel active - ${REMAINING} minutes remaining"
          
          # Health check
          if ! curl -s http://127.0.0.1:4040/api/tunnels | jq -e '.tunnels[0]' > /dev/null 2>&1; then
            echo "âš ï¸  Tunnel down! Restarting ngrok..."
            pkill ngrok
            sleep 3
            ./ngrok tcp 22 > /dev/null &
            sleep 10
          fi
          
          sleep $CHECK_INTERVAL
        done
        
        echo "âœ… Session completed"
