name: SSH Ngrok Debug

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check secrets
      run: |
        if [ -z "${{ secrets.NGROK_TOKEN }}" ]; then
          echo "❌ NGROK_TOKEN is empty!"
          exit 1
        fi
        echo "✅ NGROK_TOKEN exists (length: ${#{{ secrets.NGROK_TOKEN }}})"
    
    - name: Install ngrok
      run: |
        curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc \
          | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" \
          | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt-get update -qq
        sudo apt-get install -y ngrok
    
    - name: Test ngrok config
      run: |
        ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}
        ngrok config check
        ngrok version
    
    - name: Setup SSH
      run: |
        echo "runner:TestPass123" | sudo chpasswd
        sudo systemctl restart ssh
    
    - name: Start ngrok with verbose logging
      run: |
        ngrok tcp 22 --log=stdout --log-level=debug &
        sleep 20
        
        echo "=== Ngrok Process ==="
        ps aux | grep ngrok
        
        echo "=== Ngrok API ==="
        curl -v http://127.0.0.1:4040/api/tunnels
        
        sleep 60
