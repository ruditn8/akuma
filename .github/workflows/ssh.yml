name: SSH Ngrok Fixed

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        run: |
          echo "runner:Password123" | sudo chpasswd
          sudo systemctl start ssh
          echo "‚úÖ SSH started"
      
      - name: Install ngrok
        run: |
          sudo snap install ngrok
          echo "‚úÖ Ngrok installed"
      
      - name: Create ngrok config directory
        run: |
          mkdir -p $HOME/.config/ngrok
          chmod 755 $HOME/.config/ngrok
          echo "‚úÖ Config directory created"
      
      - name: Configure ngrok
        run: |
          ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}
          ngrok config check
          echo "‚úÖ Ngrok configured"
      
      - name: Start tunnel
        run: |
          ngrok tcp 22 > ngrok.log 2>&1 &
          echo "‚è≥ Waiting for tunnel..."
          sleep 15
          
          echo "=== Checking ngrok process ==="
          ps aux | grep ngrok | grep -v grep || echo "No ngrok process"
          
          echo ""
          echo "=== Getting tunnel info ==="
          RESPONSE=$(curl -s http://127.0.0.1:4040/api/tunnels)
          echo "$RESPONSE"
          
          URL=$(echo "$RESPONSE" | grep -o '"public_url":"[^"]*' | cut -d'"' -f4)
          
          if [ -z "$URL" ]; then
            echo "‚ùå Failed to get tunnel URL"
            echo "=== Ngrok log ==="
            cat ngrok.log
            exit 1
          fi
          
          HOST=$(echo $URL | sed 's|tcp://||' | cut -d: -f1)
          PORT=$(echo $URL | sed 's|tcp://||' | cut -d: -f2)
          
          echo ""
          echo "========================================"
          echo "üöÄ SSH Tunnel Active!"
          echo "========================================"
          echo "Host: $HOST"
          echo "Port: $PORT"
          echo "User: runner"
          echo "Pass: Password123"
          echo ""
          echo "Command:"
          echo "ssh runner@$HOST -p $PORT"
          echo "========================================"
          
          sleep 21000
      
      - name: Cleanup
        if: always()
        run: |
          pkill ngrok || true
          echo "‚úÖ Cleanup done"
