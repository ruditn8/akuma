name: SSH Ngrok with Telegram Notify

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup SSH Server
      run: |
        # SSH sudah terinstall, tinggal configure
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo systemctl restart ssh
        echo "‚úÖ SSH Server configured"
    
    - name: Set User Password
      run: |
        echo "runner:${{ secrets.SSH_PASSWORD }}" | sudo chpasswd
        echo "‚úÖ Password set for user: runner"
    
    - name: Install ngrok
      run: |
        curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc \
          | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" \
          | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt-get update -qq
        sudo apt-get install -y ngrok
        echo "‚úÖ Ngrok installed"
    
    - name: Configure ngrok authtoken
      run: |
        ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}
        ngrok config check
        echo "‚úÖ Ngrok configured"
    
    - name: Start ngrok tunnel
      run: |
        # Start ngrok dengan output ke file
        ngrok tcp 22 --log=stdout --log-level=info > ngrok.log 2>&1 &
        NGROK_PID=$!
        
        echo "‚è≥ Waiting for ngrok to initialize..."
        sleep 15
        
        # Verify ngrok masih running
        if ! ps -p $NGROK_PID > /dev/null; then
          echo "‚ùå Ngrok process died!"
          echo "=== Ngrok Log ==="
          cat ngrok.log
          exit 1
        fi
        
        echo "‚úÖ Ngrok running (PID: $NGROK_PID)"
    
    - name: Get tunnel URL
      id: tunnel
      run: |
        # Retry mechanism
        for i in {1..15}; do
          echo "Attempt $i/15..."
          
          RESPONSE=$(curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null || echo "")
          
          if [ -n "$RESPONSE" ]; then
            NGROK_URL=$(echo "$RESPONSE" | jq -r '.tunnels[0].public_url // empty')
            
            if [ -n "$NGROK_URL" ]; then
              echo "‚úÖ Got tunnel URL: $NGROK_URL"
              
              NGROK_HOST=$(echo $NGROK_URL | sed 's|tcp://||' | cut -d':' -f1)
              NGROK_PORT=$(echo $NGROK_URL | sed 's|tcp://||' | cut -d':' -f2)
              
              echo "NGROK_HOST=$NGROK_HOST" >> $GITHUB_OUTPUT
              echo "NGROK_PORT=$NGROK_PORT" >> $GITHUB_OUTPUT
              echo "NGROK_URL=$NGROK_URL" >> $GITHUB_OUTPUT
              
              exit 0
            fi
          fi
          
          sleep 2
        done
        
        echo "‚ùå Failed to get tunnel URL after 15 attempts"
        echo "=== Ngrok API Response ==="
        curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null | jq . || echo "No response"
        echo "=== Ngrok Log ==="
        cat ngrok.log
        exit 1
    
    - name: Display connection info
      run: |
        echo "=========================================="
        echo "üöÄ SSH Tunnel Active!"
        echo "=========================================="
        echo "Host: ${{ steps.tunnel.outputs.NGROK_HOST }}"
        echo "Port: ${{ steps.tunnel.outputs.NGROK_PORT }}"
        echo "User: runner"
        echo ""
        echo "üìã Connect with:"
        echo "ssh runner@${{ steps.tunnel.outputs.NGROK_HOST }} -p ${{ steps.tunnel.outputs.NGROK_PORT }}"
        echo "=========================================="
        echo "‚è∞ Active until: $(date -d '+5 hours 50 minutes' '+%Y-%m-%d %H:%M:%S UTC')"
        echo "=========================================="
    
    - name: Send Telegram notification
      if: success() && secrets.TELEGRAM_BOT_TOKEN != ''
      run: |
        MESSAGE="üöÄ <b>SSH Server Ready!</b>%0A%0A"
        MESSAGE="${MESSAGE}üñ• <b>Host:</b> <code>${{ steps.tunnel.outputs.NGROK_HOST }}</code>%0A"
        MESSAGE="${MESSAGE}üîå <b>Port:</b> <code>${{ steps.tunnel.outputs.NGROK_PORT }}</code>%0A"
        MESSAGE="${MESSAGE}üë§ <b>User:</b> <code>runner</code>%0A%0A"
        MESSAGE="${MESSAGE}üìã <b>Command:</b>%0A<code>ssh runner@${{ steps.tunnel.outputs.NGROK_HOST }} -p ${{ steps.tunnel.outputs.NGROK_PORT }}</code>%0A%0A"
        MESSAGE="${MESSAGE}‚è∞ Active for ~5h 50m"
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "text=$MESSAGE" \
          -d "parse_mode=HTML"
        
        echo "‚úÖ Telegram notification sent!"
      continue-on-error: true
    
    - name: Keep tunnel alive
      run: |
        echo "üîÑ Keeping tunnel alive for 5h 50m..."
        
        END_TIME=$(($(date +%s) + 21000))
        
        while [ $(date +%s) -lt $END_TIME ]; do
          REMAINING=$((($END_TIME - $(date +%s)) / 60))
          echo "[$(date '+%H:%M:%S')] ‚úÖ Tunnel active - ${REMAINING} minutes remaining"
          
          # Health check setiap loop
          if ! curl -s http://127.0.0.1:4040/api/tunnels | jq -e '.tunnels[0]' > /dev/null 2>&1; then
            echo "‚ö†Ô∏è Tunnel lost! Attempting restart..."
            pkill ngrok
            sleep 5
            ngrok tcp 22 --log=stdout > ngrok.log 2>&1 &
            sleep 10
          fi
          
          sleep 300  # Check every 5 minutes
        done
        
        echo "‚è∞ Session completed"
    
    - name: Cleanup
      if: always()
      run: |
        echo "üßπ Cleaning up..."
        pkill ngrok || true
        echo "‚úÖ Done"
